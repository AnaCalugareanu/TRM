<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Harry Potter AR - Final Audio</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #start-btn {
            padding: 15px 30px;
            font-size: 20px;
            background: #7f0909;
            color: #ffbf00; 
            border: 2px solid #ffbf00;
            border-radius: 10px;
            font-family: serif;
            font-weight: bold;
            cursor: pointer;
        }

        #loading-text {
            color: white;
            font-family: sans-serif;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="start-screen">
        <button id="start-btn">ENTER WIZARDING WORLD</button>
        <div id="loading-text">Loading Spells... Please wait.</div>
    </div>

    <a-scene vr-mode-ui="enabled: false;"
             renderer="logarithmicDepthBuffer: true;"
             embedded
             arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-assets>
            <audio id="sound-wand" src="./assets/wand.mp3" preload="auto"></audio>
            <audio id="sound-success" src="./assets/success.mp3" preload="auto"></audio>
        </a-assets>

        <script>
            let isUnlocked = false;
            let wandPlayed = false;
            let successPlayed = false;

            // LOGICA PENTRU BUTONUL DE START
            window.addEventListener('load', () => {
                const startBtn = document.getElementById('start-btn');
                const startScreen = document.getElementById('start-screen');
                const loadingText = document.getElementById('loading-text');

                // Audio elements
                const sWand = document.querySelector('#sound-wand');
                const sSuccess = document.querySelector('#sound-success');

                startBtn.addEventListener('click', () => {
                    // Truc: Redam sunetele la volum 0 pentru o secunda ca sa le "deblocam" in browser
                    sWand.play().then(() => sWand.pause());
                    sSuccess.play().then(() => sSuccess.pause());

                    startBtn.style.display = 'none';
                    loadingText.style.display = 'block';

                    // Ascundem ecranul dupa 2 secunde (timp sa se incarce AR-ul)
                    setTimeout(() => {
                        startScreen.style.display = 'none';
                    }, 2000);
                });
            });

            AFRAME.registerComponent('magic-handler', {
                init: function () {
                    const markerKey = document.querySelector('#marker-key');
                    const markerBase = document.querySelector('#marker-base');
                    const magicChest = document.querySelector('#magic-chest');
                    const statusText = document.querySelector('#status-text');

                    const sWand = document.querySelector('#sound-wand');
                    const sSuccess = document.querySelector('#sound-success');

                    // --- CAND GASESTI CHEIA ---
                    markerKey.addEventListener('markerFound', () => {
                        isUnlocked = true;
                        if (!wandPlayed) {
                            sWand.currentTime = 0;
                            sWand.play();
                            wandPlayed = true; // Redam o singura data
                        }
                    });

                    // --- CAND GASESTI BAZA ---
                    markerBase.addEventListener('markerFound', () => {
                        if (isUnlocked) {
                            // Cufar Deschis
                            magicChest.setAttribute('visible', 'true');
                            statusText.setAttribute('value', 'ALOHOMORA!\nVault Open');
                            statusText.setAttribute('color', '#FFD700');
                            statusText.setAttribute('scale', '80 80 80');

                            if (!successPlayed) {
                                sSuccess.currentTime = 0;
                                sSuccess.play();
                                successPlayed = true;
                            }
                        } else {
                            // Cufar Blocat
                            magicChest.setAttribute('visible', 'false');
                            statusText.setAttribute('value', 'LOCKED');
                            statusText.setAttribute('color', 'red');
                            statusText.setAttribute('scale', '100 100 100');
                        }
                    });

                }
            });
        </script>

        <a-nft id="marker-key" magic-handler type="nft" url="./nft/alp"
               smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
            <a-text value="MAGIC FOUND" rotation="-90 0 0" scale="80 80 80" align="center" color="cyan"></a-text>
        </a-nft>

        <a-nft id="marker-base" magic-handler type="nft" url="./nft/ap"
               smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">

            <a-entity id="magic-chest"
                      gltf-model="./assets/chest.glb"
                      scale="150 150 150"
                      position="0 0 0"
                      rotation="0 0 0"
                      visible="false"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
            </a-entity>

            <a-text id="status-text" value="LOCKED" rotation="-90 0 0" position="0 0 -100"
                    scale="100 100 100" align="center" color="red">
            </a-text>
        </a-nft>
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>