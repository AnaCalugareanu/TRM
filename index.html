<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Harry Potter AR - Grade 10</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #start-btn {
            padding: 15px 30px;
            font-size: 20px;
            background: #7f0909;
            color: #ffbf00;
            border: 2px solid #ffbf00;
            border-radius: 10px;
            font-family: serif;
            font-weight: bold;
            cursor: pointer;
        }

        #instructions {
            color: #d4af37;
            font-family: serif;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2em;
            display: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="start-screen">
        <button id="start-btn">ENTER WIZARDING WORLD</button>
        <div id="instructions">
            1. Find the Crest (Key)<br>
            2. Find the Poster (Chest)<br>
            3. TAP SCREEN to cast spells!
        </div>
    </div>

    <a-scene vr-mode-ui="enabled: false;"
             renderer="logarithmicDepthBuffer: true;"
             embedded
             arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-assets>
            <audio id="sound-wand" src="./assets/wand.mp3" preload="auto"></audio>
            <audio id="sound-success" src="./assets/success.mp3" preload="auto"></audio>
        </a-assets>

        <script>
            let isUnlocked = false;
            let wandPlayed = false;
            let chestVisible = false;

            // Logica de Start
            window.addEventListener('load', () => {
                const startBtn = document.getElementById('start-btn');
                const startScreen = document.getElementById('start-screen');
                const instructions = document.getElementById('instructions');

                // Sunete
                const sWand = document.querySelector('#sound-wand');
                const sSuccess = document.querySelector('#sound-success');
                const magicChest = document.querySelector('#magic-chest');

                startBtn.addEventListener('click', () => {
                    sWand.play().then(() => sWand.pause());
                    sSuccess.play().then(() => sSuccess.pause());

                    startBtn.style.display = 'none';
                    instructions.style.display = 'block';

                    setTimeout(() => {
                        startScreen.style.display = 'none';
                    }, 3000);
                });

                // --- SCENARIUL 2: INTERACTIUNE LA CLICK (TOUCH) ---
                window.addEventListener('click', () => {
                    if (chestVisible) {
                        // Daca cufarul e vizibil si dam click -> ANIMATIE DE PULS
                        // Il marim si il micsoram la loc
                        magicChest.setAttribute('animation__pulse', 'property: scale; to: 200 200 200; dur: 200; easing: easeInOutQuad; dir: alternate; loop: 2');

                        // Putem reda sunetul de bagheta din nou
                        sWand.currentTime = 0;
                        sWand.play();
                    }
                });
            });

            AFRAME.registerComponent('magic-handler', {
                init: function () {
                    const markerKey = document.querySelector('#marker-key');
                    const markerBase = document.querySelector('#marker-base');

                    const magicChest = document.querySelector('#magic-chest');
                    const statusText = document.querySelector('#status-text');

                    const sWand = document.querySelector('#sound-wand');
                    const sSuccess = document.querySelector('#sound-success');

                    // 1. CHEIA
                    markerKey.addEventListener('markerFound', () => {
                        isUnlocked = true;
                        if (!wandPlayed) {
                            sWand.currentTime = 0;
                            sWand.play();
                            wandPlayed = true;
                        }
                    });

                    // 2. BAZA
                    markerBase.addEventListener('markerFound', () => {
                        if (isUnlocked) {
                            // DEBLOCAT
                            chestVisible = true;
                            magicChest.setAttribute('visible', 'true');

                            statusText.setAttribute('value', 'ALOHOMORA!\nTap screen to cast spell');
                            statusText.setAttribute('color', '#FFD700');
                            statusText.setAttribute('scale', '60 60 60');

                            // Redam sunet succes o singura data la aparitie
                            if (magicChest.getAttribute('scale').x === 150) {
                                // mic hack ca sa nu sune incontinuu
                                sSuccess.play();
                            }

                        } else {
                            // BLOCAT
                            chestVisible = false;
                            magicChest.setAttribute('visible', 'false');

                            statusText.setAttribute('value', 'LOCKED');
                            statusText.setAttribute('color', 'red');
                            statusText.setAttribute('scale', '100 100 100');
                        }
                    });

                    markerBase.addEventListener('markerLost', () => {
                        chestVisible = false;
                    });
                }
            });
        </script>

        <a-nft id="marker-key" magic-handler type="nft" url="./nft/alp"
               smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
            <a-text value="MAGIC FOUND" rotation="-90 0 0" scale="80 80 80" align="center" color="cyan"></a-text>
        </a-nft>

        <a-nft id="marker-base" magic-handler type="nft" url="./nft/ap"
               smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">

            <a-entity id="magic-chest"
                      gltf-model="./assets/chest.glb"
                      scale="150 150 150"
                      position="0 0 0"
                      rotation="0 0 0"
                      visible="false"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
            </a-entity>

            <a-text id="status-text" value="LOCKED" rotation="-90 0 0" position="0 0 -100"
                    scale="100 100 100" align="center" color="red">
            </a-text>
        </a-nft>
        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>