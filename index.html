<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Harry Potter AR - Final Exam</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0d0d0d; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-image: radial-gradient(circle, #2a2a2a 0%, #000000 100%);
        }
        #start-btn {
            padding: 15px 40px; font-size: 22px; 
            background: #740001; color: #eeba30;
            border: 3px solid #eeba30; border-radius: 8px;
            font-family: serif; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px #eeba30;
        }
        #warning-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #cc0000; font-size: 3em; font-weight: bold; font-family: serif;
            text-shadow: 0 0 20px black; display: none; z-index: 9998;
            pointer-events: none; border: 5px solid #cc0000; padding: 20px; background: rgba(0,0,0,0.8);
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="warning-msg">DEMENTOR ATTACK!<br>KEY STOLEN!</div>

    <div id="start-screen">
        <button id="start-btn">ENTER WIZARDING WORLD</button>
        <div style="color:gray; margin-top:20px; font-family:serif;">
            Find Key -> Open Chest -> Avoid Dementors
        </div>
    </div>

    <a-scene
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-assets>
            <audio id="sound-wand" src="./assets/wand.mp3" preload="auto"></audio>
            <audio id="sound-success" src="./assets/success.mp3" preload="auto"></audio>
        </a-assets>

        <script>
            let isUnlocked = false; 
            let chestVisible = false;

            window.addEventListener('load', () => {
                const startBtn = document.getElementById('start-btn');
                const startScreen = document.getElementById('start-screen');
                const warningMsg = document.getElementById('warning-msg');
                
                const sWand = document.querySelector('#sound-wand');
                const sSuccess = document.querySelector('#sound-success');
                const magicChest = document.querySelector('#magic-chest');

                startBtn.addEventListener('click', () => {
                    sWand.play().then(() => sWand.pause());
                    sSuccess.play().then(() => sSuccess.pause());
                    startScreen.style.display = 'none';
                });

                // CLICK: Doar cufarul reactioneaza, gratiile NU.
                window.addEventListener('click', () => {
                    if (chestVisible && isUnlocked) {
                        magicChest.setAttribute('animation__pulse', 'property: scale; to: 200 200 200; dur: 200; easing: easeInOutQuad; dir: alternate; loop: 2');
                        sWand.currentTime = 0;
                        sWand.play();
                    }
                });

                AFRAME.registerComponent('magic-handler', {
                    init: function () {
                        const markerKey = document.querySelector('#marker-key');
                        const markerBase = document.querySelector('#marker-base');
                        const markerEnemy = document.querySelector('#marker-enemy');
                        
                        const magicChest = document.querySelector('#magic-chest');
                        const jailModel = document.querySelector('#jail-model');
                        const statusText = document.querySelector('#status-text');

                        // 1. CHEIA
                        markerKey.addEventListener('markerFound', () => {
                            if (!isUnlocked) {
                                isUnlocked = true;
                                console.log("Cheie recuperata!");
                                sWand.currentTime = 0;
                                sWand.play();
                            }
                        });

                        // 2. INAMICUL (Fura Cheia)
                        markerEnemy.addEventListener('markerFound', () => {
                            if (isUnlocked) {
                                isUnlocked = false; 
                                warningMsg.style.display = 'block';
                                setTimeout(() => { warningMsg.style.display = 'none'; }, 3000);
                            }
                        });

                        // 3. POSTERUL (Baza)
                        markerBase.addEventListener('markerFound', () => {
                            if (isUnlocked) {
                                // --- CAZUL FERICIT (DESCHIS) ---
                                chestVisible = true;
                                magicChest.setAttribute('visible', 'true');
                                jailModel.setAttribute('visible', 'false'); // Ascundem gratiile
                                
                                statusText.setAttribute('value', 'ALOHOMORA!\nVault Open');
                                statusText.setAttribute('color', '#FFD700'); 
                                statusText.setAttribute('scale', '80 80 80');

                                if (magicChest.getAttribute('scale').x === 150) { 
                                    sSuccess.play();
                                }
                            } else {
                                // --- CAZUL TRIST (BLOCAT) ---
                                chestVisible = false;
                                magicChest.setAttribute('visible', 'false');
                                jailModel.setAttribute('visible', 'true'); // Aratam gratiile
                                
                                statusText.setAttribute('value', 'LOCKED\nPrisoner Trapped!');
                                statusText.setAttribute('color', 'red');
                                statusText.setAttribute('scale', '100 100 100');
                            }
                        });
                        
                        markerBase.addEventListener('markerLost', () => {
                            chestVisible = false;
                        });
                    }
                });
            });
        </script>

        <a-nft id="marker-key" magic-handler type="nft" url="./nft/alp"
            smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
            <a-text value="KEY RECOVERED" rotation="-90 0 0" scale="80 80 80" align="center" color="cyan"></a-text>
        </a-nft>

        <a-nft id="marker-enemy" magic-handler type="nft" url="./nft/bad"
            smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
        </a-nft>

        <a-nft id="marker-base" magic-handler type="nft" url="./nft/ap"
            smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">

            <a-entity
                id="magic-chest"
                gltf-model="./assets/chest.glb"
                scale="150 150 150"
                position="0 0 0"
                rotation="0 0 0"
                visible="false"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
            </a-entity>

            <a-entity
                id="jail-model"
                gltf-model="./assets/jail.glb"
                scale="150 150 150" 
                position="0 0 0"
                rotation="0 0 0"
                visible="false">
            </a-entity>
            <a-text id="status-text" value="LOCKED" rotation="-90 0 0" position="0 0 -100"
                scale="100 100 100" align="center" color="red">
            </a-text>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>